# USB 電氣信號
## USB 概述
- USB 2.0 支援三種速度： 低速( Low Speed )、全速( Full Speed )和高速( Full Speed )。
- 一個 USB 設備，可能兼容低速和全速，或是兼容全速和高速。但是無法兼容低速和高速。

## USB 電子訊號
- USB 連接線有4條。 5V 、D+ 、 D- 和 GND 。
- USB Hub 的 D+ 和 D- 都有 15K 下拉的電阻。 平時為低電平。 全速設備的 D+ 有 1.5K 的上拉電阻。 低速設備內部 D- 有 1.5K 的上拉電阻。 連接 Hub 後會導致 Hub 的 D+ 或是 D- 發生電平的變化。 Hub 根據引腳分辨接近來的是全速或是低速設備。
- 高速設備一開始是作為全速設備去連接 Hub 。連接好後，被識別高速設備，那 D+ 的上拉電阻便斷開。對於高速設備無法透過 D+ 和 D- 的電平變化來分辨是否斷開。
- 高速設備的 D+ 和 D- 兩邊都有45歐姆的下拉電阻( Hub 和 Device 端)，用來消除反射信號。當 Hub 偵測到反射信號就知道設備已經斷開了。
- USB 使用 NRZI ( Non Return Zero Inverted Code )來編碼。
- NRZI 的編碼方式為：對於數據0,波形翻轉。對於數據1，波形不變。
- 連續傳送六個1的時候會自動插入一個0。以免電平長時間不變，資料偏差。接收方收到六個1的時候會自動把後面的0刪除，就可以得到正確的數據。

# USB 數據格式
## 硬體拓樸結構
- compound device：多個設備組合起來，透過 Hub 和 Host相連。
- composite device： 一個設備裡面有多個 interface。

## 協議
- 字節和位元順序為先傳輸低位 ( LSB )
- 包格式
	```
	+---------+---------+-----------------+----------+
	| SOP     | SYNC    | Packet Content  | EOP      |
	+---------+---------+-----------------+----------+

	Packet Content:
	+---------+-------------------------------+----------+
	| PID     | Address / Frame Number / Data | CRC      |
	+---------+-------------------------------+----------+

	```
- 包的內容
	* SOP：用來表示包的起始。
	* SYNC：用來同步時鐘。低速/全速設備為8位數據( 00000001 )。高速設備為32位數據( 00000000000000000000000000000001 )。
	* PID：用來表示包的類型。 PID 為8 bits。結構是 **低 4 bit（實際編碼）+ 高 4 bit（低 4 bit 的反碼）**，用來做錯誤檢查。也就是說：
	```
	PID[7:4] = NOT(PID[3:0])
	PID[3:0] = 真正的封包類別編號
	```
	Token 類
	| PID (低 4bit) | 名稱    | 功能                           |
	| ------------ | ----- | ---------------------------- |
	| `0001` (0x1) | OUT   | Host → Device 傳輸             |
	| `1001` (0x9) | IN    | Device → Host 傳輸             |
	| `0101` (0x5) | SOF   | Start of Frame (傳輸 frame 編號) |
	| `1101` (0xD) | SETUP | Control transfer (初始化/設定)    |

	Data 類
	| PID (低 4bit) | 名稱    | 功能                           |
	| ------------ | ----- | ---------------------------- |
	| `0011` (0x3) | DATA0 | 資料封包 (Data Toggle = 0)   |
	| `1011` (0xB) | DATA1 | 資料封包 (Data Toggle = 1)   |
	| `0111` (0x7) | DATA2 | 高速模式下額外資料封包              |
	| `1111` (0xF) | MDATA | 多重資料封包 (High-speed only) |

	Hankshake 類
	| PID (低 4bit) | 名稱    | 功能                           |
	| ------------ | ----- | ---------------------------- |
	| `0010` (0x2) | ACK   | 確認成功收到                           |
	| `1010` (0xA) | NAK   | 裝置暫時無法處理 (Not Ready)             |
	| `1110` (0xE) | STALL | 裝置錯誤或端點停用                        |
	| `0110` (0x6) | NYET  | High-speed Only：表示接收成功但無法馬上接收下一個 |

	特殊類
	| PID (低 4bit) | 名稱    | 功能                           |
	| ------------ | ----- | ---------------------------- |	
	| `1100` (0xC) | PRE   | USB 1.1 用於通知低速傳輸                         |
	| `0011` (0x3) | ERR   | 錯誤 (USB 2.0 保留)                          |
	| `1000` (0x8) | SPLIT | High-speed hub 分割傳輸                      |
	| `0100` (0x4) | PING  | High-speed host 查詢 device 是否準備好 OUT data |

- Token Packet
	```
	Out / In / Setup
	+--------+------+--------------------------+------+
	| SYNC   | PID  | ADDR (7 bits) + ENDP(4) | CRC   |
	+--------+------+--------------------------+------+

	SOF
	+--------+--------+------------------+------+
	| SYNC   | PID    | FrameNumber(11)  | CRC  |
	+--------+--------+------------------+------+

	```
- Data Packet
	Data 0 和 Data 1 主要是用來糾錯。Host 和 device 都會維護自己的 Data Packet 切換機制。 這次收到 Data 0 那就會期待下一次收到的是 Data 1 。如果收到的 Data 類型不對，那就知道有錯誤發生。

	```
	+--------+--------+-------------------+-------+------+
	| SYNC   | PID    | DATA Payload (N)  | CRC16 | EOP  |
	+--------+--------+-------------------+-------+------+

	```
- Handshake Packet
	```
	+--------+--------+------+
	| SYNC   | PID    | EOP  |
	+--------+--------+------+

	```
- Transaction (事務)
	四類事務：
	* 批量事務：傳輸大量數據。數據的正確性有保證，但時效性沒有保證。
	* 中斷事務：用來傳輸週期性的、小量的數據。數據正確性和時效性有保證。
	* 實時事務：用來傳輸實時數據。數據的正確性沒有保證，時效性有保證。
	* 建立事務：和批量事務類似。 Token 包為 Setup packet。



